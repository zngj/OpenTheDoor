#Flow

	Demo: 
		暂不做数据加解密及近场数据快递刷新混淆处理，时间充裕的话再考虑完善
		不包含自动代扣，采取小程序提前充值，余额扣款的方式
		进站/出站/扣费通知 先按https轮询(3秒)
		闸机与后端用自定义协议
		小程序与后端用https+json

## 用户端

	获取用户标识:
		if 微信: openId/unionId等
		elif 支付宝: userId
		elif APP:
			if 已登录 : userId
			else : 提示注册或登录
	if 不存在活动中行程:
		进站
			 **用户二维码** （包含用户、时间戳)，可选下一个生成新的二维码
			 **闸机二维码** （包含闸机、时间戳），多次扫描多人进站
	elif 存在活动中的行程:
		if 活动行程超过线路最大时长:
			可选：
				异常行程、实际已出站（针对非正常结束场景，按最远距离结束行程并扣费？）
				展示对应出站二维码（地铁内长期滞留？）
				存在异常行程，不可再生成进站二维码(demo)，用户需要处理或申诉（以后）
		else:
			展示出站二维码，可选下一个出站二维码
			或扫码出站，可多次扫描（多人）
## 用户端云服务

	查询行程订单
	生成待进站订单信息（同一用户允许同时存在多个）
	根据已进站信息生成对应的出站信息
	支付、代扣服务等
		小程序支付（https://pay.weixin.qq.com/wiki/doc/api/wxa/wxa_api.php?chapter=7_7&index=3）

## 终端

	取得输入(二维码、声波等)：
		if 非约定格式：
			提示联系客服
		elif 约定格式(x秒内多数据交叉验证):
			校验数据合法性（请求终端云服务，带上任一输入信息及闸口信息）
			if 数据合法:
				[开闸](#开闸)
			elif 数据不合法：
				根据返回信息进行提示
			elif 请求失败：
				是否允许失败优先通过（配置项，可选）
				if 允许: 
					[开闸](#开闸)
				else: 提示联系客服 
	开闸：
		调用现有开闸接口（是否能获得开闸成功的信息？）
		确认开闸成功（请求终端云服务，带上输入信息及闸口信息，请求失败缓冲回传）

##终端云服务

	校验终端数据合法性
		若为入站
			验证用户信息有效性，有效则允许进站，禁止进站场景如下：（demo暂不支持禁入场景）
				1. 入站交易信息无效（如伪造）
				2. 无有效扣款渠道（无余额且没有签约代扣）（开关可选，所有人均允许先进站则无需判断）
				3. 当前有欠费（如上次自动扣款失败：上次行程余额不足或者代扣卡余额不足）（开关可选，若允许先出站再扣费则需要）
		若为出站
			验证用户信息及出站交易订单有效性，有效则允许进站，禁止出站场景如下：（demo仅支持余额不足不允许出站）
				1. 未签约代扣，且余额不足
				2. 签约了代扣，但存在代扣失败的欠款（如连续多人出站，而前几单代扣因余额不足而代扣失败）
				3. 余额不足 (若要求先付费再出站，则无法使用代付，需要用户端至少充值路费金额)
	
	确认开闸成功
		进行扣费并结束行程（若允许先出站再扣费）
		
	行程计费 (demo暂用模拟计算，随机2～5元)
		与各地铁系统打通，获取计费信息，供用户端查价
	
		

## 客服端

	用户联系客服时，
		若为进站故障，引导重试，实在不行就放弃扫码
		若出站故障，扫码读取出站订单，直接选择当前站点作为出站点结算行程，走特殊通道离站
